name: Build DEB Packages

on:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      version_tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build'
        required: true
        type: string
      version_tag:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  display_version:
    name: Display Version
    runs-on: ubuntu-latest
    steps:
      - name: Display Version Info
        run: |
          echo "### ðŸ“¦ Building DEB Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Tag**: ${{ inputs.version_tag }}" >> $GITHUB_STEP_SUMMARY

  generate_matrix:
    name: Generate Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate matrix
        id: set-matrix
        run: |
          MATRIX=$(python3 .github/scripts/generate-matrix.py)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Generated matrix:"
          echo "$MATRIX" | python3 -m json.tool

  build_deb:
    name: Build ${{ matrix.distro }} ${{ matrix.version }} (${{ matrix.arch }})
    needs: [display_version, generate_matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate_matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU for cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Update version in files
        run: |
          .github/scripts/update-version.sh \
            "${{ inputs.version }}" \
            "${{ matrix.codename }}"

      - name: Build DEB package
        run: |
          .github/scripts/build-deb-docker.sh \
            "${{ matrix.distro }}" \
            "${{ matrix.codename }}" \
            "${{ matrix.arch }}"

      - name: List built packages
        run: |
          echo "### ðŸ“¦ Built Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh deb-packages/*.deb || echo "No .deb files found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload DEB packages
        uses: actions/upload-artifact@v6
        with:
          name: deb-${{ matrix.distro }}-${{ matrix.version }}-${{ matrix.arch }}
          path: deb-packages/*.deb
          if-no-files-found: error

  create_apt_repository:
    name: Create APT Repository Structure
    needs: [display_version, generate_matrix, build_deb]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Download all DEB artifacts
        uses: actions/download-artifact@v7
        with:
          path: all-debs
          pattern: deb-*

      - name: Install APT repository tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg

      - name: Organize packages by distribution
        run: .github/scripts/organize-packages.sh all-debs apt-repo

      - name: Create Packages files
        run: .github/scripts/create-packages-files.sh apt-repo

      - name: Create Release files
        run: .github/scripts/create-release-files.sh apt-repo

      - name: Create directory structure info
        run: |
          .github/scripts/create-repo-readme.sh \
            "${{ inputs.version }}" \
            "${{ inputs.version_tag }}" \
            apt-repo/README.md

      - name: Upload APT repository structure
        uses: actions/upload-artifact@v6
        with:
          name: apt-repository
          path: apt-repo/

      - name: Package summary
        run: |
          echo "### ðŸ“¦ APT Repository Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Repository structure:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tree apt-repo/ || find apt-repo/ -type f
          echo '```' >> $GITHUB_STEP_SUMMARY

  publish_debs:
    name: Publish DEB Packages to Release
    needs: [display_version, generate_matrix, build_deb, create_apt_repository]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6

      - name: Download all DEB artifacts
        uses: actions/download-artifact@v7
        with:
          path: all-debs
          pattern: deb-*

      - name: Download APT repository
        uses: actions/download-artifact@v7
        with:
          name: apt-repository
          path: apt-repo

      - name: Organize packages for release
        run: |
          mkdir -p release-packages
          find all-debs -name "*.deb" -exec cp {} release-packages/ \;
          ls -lh release-packages/

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version_tag }}
          name: Release ${{ inputs.version }}
          files: |
            release-packages/*.deb
            apt-repo/README.md
          generate_release_notes: true
          body: |
            ## Version ${{ inputs.version }}

            ### DEB Package Installation

            #### Quick Install (Debian/Ubuntu)
            ```bash
            # Download the package for your architecture and distribution
            VERSION="${{ inputs.version }}"
            TAG="${{ inputs.version_tag }}"
            wget https://github.com/the78mole/cpu-loader/releases/download/${TAG}/cpu-loader_${VERSION}-1_<arch>.deb
            sudo dpkg -i cpu-loader_${VERSION}-1_<arch>.deb
            sudo apt-get install -f
            ```

            #### Available Packages
            - **Debian 12 (Bookworm)**: amd64, arm64, armhf, riscv64
            - **Debian 13 (Trixie)**: amd64, arm64, armhf, riscv64
            - **Ubuntu 22.04 (Jammy)**: amd64, arm64, armhf, riscv64
            - **Ubuntu 24.04 (Noble)**: amd64, arm64, armhf, riscv64

            ### PyPI Installation
            ```bash
            pip install cpu-loader==${{ inputs.version }}
            ```

            ### Usage
            After installation:
            ```bash
            cpu-loader
            ```
